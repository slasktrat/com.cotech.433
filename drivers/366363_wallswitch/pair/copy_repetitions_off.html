<script>
var options = {
	id: 'copy_repetitions_off',
	title: 'views.copy_repetitions_off.title',
	body: 'views.copy_repetitions_off.body',
	hideBar: 'on',
	previous: true,
	next: false,
    svg: '<?xml version="1.0" encoding="utf-8"?>\n' +
    '<!-- Generator: Adobe Illustrator 17.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->\n' +
    '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' +
    '<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n' +
    '\t width="180.708px" height="180.709px" viewBox="0 0 180.708 180.709" enable-background="new 0 0 180.708 180.709"\n' +
    '\t xml:space="preserve" xmlns:pulse="-">\n' +
    '<path fill="#040202" d="M163.672,2.126H17.036c-4.1,0-7.827,1.678-10.53,4.381c-2.703,2.702-4.38,6.43-4.38,10.53v146.635\n' +
    '\tc0,8.201,6.709,14.911,14.91,14.911h146.636c4.099,0,7.827-1.678,10.529-4.381c2.703-2.703,4.381-6.43,4.381-10.53V17.037\n' +
    '\tC178.582,8.835,171.873,2.126,163.672,2.126 M17.036,0h146.636c9.37,0,17.036,7.666,17.036,17.037v146.635\n' +
    '\tc0,4.686-1.916,8.946-5.004,12.033c-3.087,3.088-7.346,5.004-12.032,5.004H17.036C7.666,180.709,0,173.042,0,163.672V17.037\n' +
    '\tc0-4.686,1.916-8.946,5.003-12.033C8.09,1.916,12.35,0,17.036,0z"/>\n' +
    '<path fill="#040202" d="M152.229,21.584H28.478c-2.052,0-3.917,0.84-5.269,2.192c-1.352,1.352-2.192,3.218-2.192,5.269v123.752\n' +
    '\tc0,2.051,0.84,3.917,2.192,5.269c1.352,1.352,3.217,2.192,5.269,2.192h123.751c2.052,0,3.917-0.84,5.27-2.192\n' +
    '\tc1.352-1.352,2.192-3.218,2.192-5.269V29.045c0-2.051-0.84-3.917-2.193-5.269C156.146,22.424,154.281,21.584,152.229,21.584\n' +
    '\t M28.478,20.592h123.751c2.325,0,4.439,0.951,5.971,2.483c1.532,1.532,2.483,3.645,2.483,5.97v123.752\n' +
    '\tc0,2.325-0.951,4.439-2.483,5.97c-1.532,1.532-3.646,2.483-5.971,2.483H28.478c-2.325,0-4.439-0.951-5.97-2.483\n' +
    '\tc-1.532-1.531-2.483-3.645-2.483-5.97V29.045c0-2.325,0.951-4.438,2.483-5.97C24.039,21.543,26.153,20.592,28.478,20.592z"/>\n' +
    '<path fill="#040202" d="M152.229,23.569H28.478c-1.506,0-2.875,0.616-3.868,1.609c-0.993,0.993-1.609,2.362-1.609,3.868v123.751\n' +
    '\tc0,1.506,0.616,2.875,1.609,3.868s2.362,1.609,3.868,1.609h123.751c1.506,0,2.876-0.616,3.868-1.609\n' +
    '\tc0.993-0.993,1.609-2.362,1.609-3.868V29.045c0-1.506-0.616-2.875-1.609-3.868C155.105,24.185,153.735,23.569,152.229,23.569\n' +
    '\t M28.478,22.576h123.751c1.78,0,3.397,0.728,4.57,1.9c1.172,1.172,1.899,2.79,1.899,4.569v123.751c0,1.779-0.727,3.397-1.899,4.569\n' +
    '\tc-1.173,1.173-2.79,1.9-4.57,1.9H28.478c-1.779,0-3.397-0.727-4.569-1.9c-1.172-1.172-1.9-2.79-1.9-4.569V29.045\n' +
    '\tc0-1.779,0.728-3.397,1.9-4.569C25.081,23.304,26.699,22.576,28.478,22.576z"/>\n' +
    '<path pulse:state="1" fill-rule="evenodd" clip-rule="evenodd" fill="#FFFFFF" d="M23.001,89.858h134.705V29.045c0-1.506-0.616-2.875-1.609-3.868\n' +
    '\tc-0.992-0.993-2.362-1.609-3.868-1.609H28.478c-1.506,0-2.875,0.616-3.868,1.609c-0.993,0.993-1.609,2.362-1.609,3.868V89.858z"/>\n' +
    '<path pulse:initial="true" pulse:state="0" fill-rule="evenodd" clip-rule="evenodd" fill="#FFFFFF" d="M157.706,91.984H23.001v60.812c0,1.506,0.616,2.875,1.609,3.868\n' +
    '\ts2.362,1.609,3.868,1.609h123.751c1.506,0,2.876-0.616,3.868-1.609c0.993-0.993,1.609-2.362,1.609-3.868V91.984z"/>\n' +
    '</svg>',
    svgWidth: '80vw',
    svgHeight: '70vh',
};
Homey.setTitle(__(options.title || ''));
Homey.emit('init', options.id);
Homey.on('show_view', function(viewId){
	Homey.showView(viewId);
});
Homey.on('close', function(){
	Homey.close();
});
Homey.on('nextView', function(viewsIds){
	var viewIndex = viewsIds.indexOf(options.id) + 1;
	if(viewIndex > 0 && viewIndex < viewsIds.length){
		Homey.showView(viewsIds[viewIndex]);
	}
});
Homey.on('previousView', function(viewsIds){
	var viewIndex = viewsIds.indexOf(options.id) - 1;
	if(viewIndex >= 0){
		Homey.showView(viewsIds[viewIndex]);
	}
});
function nextView(){
	if(options.next){
		Homey.nextView();
	}else{
		Homey.emit('next');
	}
}
</script>
<link href="../../../assets/433_generator/css/styles.css" rel="stylesheet" type="text/css"/>
<link href="../../../assets/433_generator/css/svg.css" rel="stylesheet" type="text/css"/>
<script src="../../../assets/433_generator/js/svghighlighter.js" type="text/javascript"></script>

<div class="centered-container">
	<div id="image-container"></div>
	<div id="progress-container">
		<div class="on" style="display: none;"><span>On</span>
			<div class="progress-bar">
				<div></div>
			</div>
		</div>
		<div class="off" style="display: none;"><span>Off</span>
			<div class="progress-bar">
				<div></div>
			</div>
		</div>
	</div>
	<div id="body"><span class="content"></span></div>
	<div class="foundAnimation" id="foundBackground" style="display:none;"></div>
	<i class="fa fa-check-circle foundAnimation" id="found" style="display:none;" aria-hidden="true"></i>
</div>

<script>
	var idPrefix = '[data-id="' + options.id + '"] ';
	$(idPrefix + '#body > span').html(__(options.body));
	var $progressContainer = $(idPrefix + '#progress-container');
	var $onBar = $progressContainer.find('.on .progress-bar > div');
	var $offBar = $progressContainer.find('.off .progress-bar > div');

    var $imageContainer = $(idPrefix + '#image-container');
    $imageContainer.css('width', options.svgWidth).css('height', options.svgHeight);

    $imageContainer.html(options.svg);
    $imageContainer.highlight();

	if (options.hideBar === 'on') {
		$offBar.parent().parent().show();
		Homey.emit('set_listen_state', { state: 0 });
	} else if (options.hideBar === 'off') {
		$onBar.parent().parent().show();
		Homey.emit('set_listen_state', { state: 1 });
	} else {
		$onBar.parent().parent().show();
		$offBar.parent().parent().show();
	}

	Homey.emit('clear_repetitions', { keepState: options.hideBar }, function (err, device) {
		setProgress(device);
	});

	Homey.on('device_data_update', setProgress);

	function setProgress(device) {
		console.log('set progress', device);
		var onLength = ((device.data.addresses || {}).on || []).length;
		var offLength = ((device.data.addresses || {}).off || []).length;
		if (device && device.data && device.data.addresses) {
			$onBar.css('width', (onLength * 50) + '%');
			$offBar.css('width', (offLength * 50) + '%');
		}

        Homey.highlight({state:0});

		if ((options.hideBar === 'on' || onLength >= 2) && (options.hideBar === 'off' || offLength >= 2)) {
			var $foundElems = $(idPrefix + '.foundAnimation');
			const dataKey = JSON.stringify(device.data);
			window.selected_devices = [dataKey];
			window.found_devices = {};
			window.found_devices[dataKey] = device;
			$foundElems.show();
			Homey.emit('set_listen_state', -1);
			setTimeout(function () {
				$foundElems.addClass('fadeOut');
				setTimeout(nextView, 400);
			}, 500);
		}
	}
</script>

<style>
	.on, .off {
		height: 1.1em;
		padding: 1em;
		width: 55vw;
		width: calc(45vw + 5em);
	}

	.on > span, .off > span {
		float: left;
	}

	.progress-bar {
		width: 45vw;
		margin-left: 2em;
		border: 1px solid black;
		height: 1em;
		float: right;
	}

	.progress-bar > div {
		height: 100%;
		background: black;
		width: 0;
	}

	#found {
		z-index: 2;
		position: absolute;
		top: 20vh;
		left: 38vw;
		font-size: 30vh;
		color: #080;
		opacity: 1;
	}

	#foundBackground {
		z-index: 1;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		position: absolute;
		background-color: #FFF;
		opacity: 0.8;
	}

	.fadeOut {
		-webkit-transition: all 0.5s ease-in-out;
		-moz-transition: all 0.5s ease-in-out;
		-ms-transition: all 0.5s ease-in-out;
		-o-transition: all 0.5s ease-in-out;
		transition: all 0.5s ease-in-out;
		opacity: 0 !important;
	}
</style>
